<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>JavaScript UI and DOM: Animations</title>
    <script src="bower_components/kineticjs/kinetic.js"></script>
</head>

<body>
    <div id="container"></div>
    <script>
    var stage = new Kinetic.Stage({
        container: 'container',
        width: document.body.clientWidth,
        height: 500
    });

    var layer = new Kinetic.Layer(),
        fallenBallsLayer = new Kinetic.Layer();

    var deltay = 1,
        a = 0.01,
        times = [];

    function animationStep() {
        layer.find('Circle')
            .forEach(function(ball, index) {
                var t = ball.t;
                var speed = a * t * t;
                var isCollidingWithBall = 
                    fallenBallsLayer.find('Circle')
                        .some(function(other){
                            var a = ball.getX() - other.getX();
                            var b = ball.getY() - other.getY();
                            var d = ball.getRadius() + other.getRadius();
                            var d1 = Math.sqrt(a*a + b*b);
                            return d1 <= d;
                        });
                if (ball.getY() + ball.getRadius() >= stage.getHeight() ||
                    isCollidingWithBall) {
                    fallenBallsLayer.add(ball);
                    fallenBallsLayer.draw();
                } else {
                    ball.setY(ball.getY() + deltay * speed);
                }
                ball.t += 1;
            });

        requestAnimationFrame(animationStep);
        layer.draw();
    }

    animationStep();

    function startAddBall() {
        var ball = new Kinetic.Circle({
            x: Math.random() * stage.getWidth(),
            y: 15,
            radius: 15,
            fill: 'pink',
            stroke: 'purple'
        });
        ball.t = 1;
        layer.add(ball);
        times.push(1);
        setTimeout(startAddBall, 100);
    }
    startAddBall();

    stage.add(fallenBallsLayer);
    stage.add(layer);
    </script>
</body>

</html>
